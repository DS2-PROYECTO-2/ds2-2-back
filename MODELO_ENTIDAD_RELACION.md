# üìä MODELO ENTIDAD-RELACI√ìN - SISTEMA DS2

## üéØ RESUMEN GENERAL
Este documento describe el modelo de datos completo del Sistema DS2 (Django + PostgreSQL) para gesti√≥n de salas, monitores y turnos.

---

## üèóÔ∏è ENTIDADES Y ATRIBUTOS

### 1. **User** (users_user)
**Descripci√≥n:** Usuarios del sistema (administradores y monitores)

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **username** - CharField(150) - √öNICO - Nombre de usuario
- **email** - EmailField(254) - Correo electr√≥nico  
- **first_name** - CharField(150) - Nombre(s)
- **last_name** - CharField(150) - Apellido(s)
- **password** - CharField(128) - Contrase√±a hasheada
- **identification** - CharField(20) - √öNICO - N√∫mero de identificaci√≥n
- **phone** - CharField(15) - OPCIONAL - Tel√©fono
- **role** - CharField(10) - Valores: 'admin', 'monitor' - DEFAULT: 'monitor'
- **is_verified** - BooleanField - DEFAULT: False - Si est√° verificado
- **verified_by** (FK) - ForeignKey(User) - NULL PERMITIDO - Admin que verific√≥
- **verification_date** - DateTimeField - NULL PERMITIDO - Fecha de verificaci√≥n
- **is_active** - BooleanField - DEFAULT: True - Usuario activo
- **date_joined** - DateTimeField - Fecha de registro
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

#### Restricciones:
- username √öNICO
- email √öNICO  
- identification √öNICO

---

### 2. **ApprovalLink** (users_approval_link)
**Descripci√≥n:** Enlaces de aprobaci√≥n/rechazo de usuarios con expiraci√≥n

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **user** (FK) - ForeignKey(User) - Usuario a aprobar/rechazar
- **action** - CharField(10) - Valores: 'approve', 'reject'
- **token_hash** - CharField(64) - √öNICO - Hash del token
- **used_at** - DateTimeField - NULL PERMITIDO - Cu√°ndo se us√≥
- **expires_at** - DateTimeField - Fecha de expiraci√≥n
- **created_at** - DateTimeField - Auto add

#### Restricciones:
- token_hash √öNICO

---

### 3. **PasswordReset** (users_password_reset)
**Descripci√≥n:** Tokens para restablecimiento de contrase√±as

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **user** (FK) - ForeignKey(User) - Usuario que solicita reset
- **token_hash** - CharField(64) - √öNICO - Hash del token
- **used_at** - DateTimeField - NULL PERMITIDO - Cu√°ndo se us√≥
- **expires_at** - DateTimeField - Fecha de expiraci√≥n
- **created_at** - DateTimeField - Auto add

#### Restricciones:
- token_hash √öNICO

---

### 4. **Room** (rooms_room)
**Descripci√≥n:** Salas f√≠sicas del sistema

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **name** - CharField(100) - Nombre descriptivo
- **code** - CharField(10) - √öNICO - C√≥digo identificador
- **capacity** - IntegerField - Capacidad m√°xima
- **description** - TextField - OPCIONAL - Descripci√≥n adicional
- **is_active** - BooleanField - DEFAULT: True - Sala activa
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

#### Restricciones:
- code √öNICO

---

### 5. **RoomEntry** (rooms_roomentry)
**Descripci√≥n:** Registros de entrada y salida de monitores en salas

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **user** (FK) - ForeignKey(User) - Monitor que ingresa
- **room** (FK) - ForeignKey(Room) - Sala de entrada
- **entry_time** - DateTimeField - DEFAULT: now - Tiempo de entrada
- **exit_time** - DateTimeField - NULL PERMITIDO - Tiempo de salida
- **notes** - TextField - OPCIONAL - Notas adicionales
- **active** - BooleanField - DEFAULT: True - Registro activo
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 6. **Schedule** (schedule_schedule)
**Descripci√≥n:** Turnos asignados a monitores en salas

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **user** (FK) - ForeignKey(User) - Monitor asignado (role='monitor', is_verified=True)
- **room** (FK) - ForeignKey(Room) - Sala asignada
- **start_datetime** - DateTimeField - Inicio del turno
- **end_datetime** - DateTimeField - Fin del turno
- **status** - CharField(10) - Valores: 'active', 'completed', 'cancelled' - DEFAULT: 'active'
- **recurring** - BooleanField - DEFAULT: False - Si se repite semanalmente
- **notes** - TextField - OPCIONAL - Notas del turno
- **created_by** (FK) - ForeignKey(User) - NULL PERMITIDO - Admin creador (role='admin')
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

#### Restricciones:
- CHECK: end_datetime > start_datetime

---

### 7. **Equipment** (equipment_equipment)
**Descripci√≥n:** Equipos f√≠sicos en las salas

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **serial_number** - CharField(50) - √öNICO - N√∫mero de serie
- **name** - CharField(100) - Nombre/modelo del equipo
- **description** - TextField - OPCIONAL - Descripci√≥n detallada
- **room** (FK) - ForeignKey(Room) - Sala donde est√° ubicado
- **status** - CharField(20) - Valores: 'operational', 'maintenance', 'out_of_service' - DEFAULT: 'operational'
- **acquisition_date** - DateField - Fecha de adquisici√≥n
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

#### Restricciones:
- serial_number √öNICO

---

### 8. **EquipmentReport** (equipment_equipmentreport)
**Descripci√≥n:** Reportes de problemas en equipos

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **equipment** (FK) - ForeignKey(Equipment) - Equipo con problema
- **reported_by** (FK) - ForeignKey(User) - Usuario que reporta
- **issue_description** - TextField - Descripci√≥n del problema
- **issue_type** - CharField(100) - OPCIONAL - Tipo de falla
- **reported_date** - DateTimeField - Auto add - Fecha del reporte
- **resolved** - BooleanField - DEFAULT: False - Si est√° resuelto
- **resolved_date** - DateTimeField - NULL PERMITIDO - Fecha de resoluci√≥n
- **resolution_notes** - TextField - OPCIONAL - Notas de resoluci√≥n
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 9. **Attendance** (attendance_attendance)
**Descripci√≥n:** Listados de asistencia subidos por monitores

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **title** - CharField(200) - T√≠tulo descriptivo
- **date** - DateField - Fecha del listado
- **uploaded_by** (FK) - ForeignKey(User) - Monitor que sube el archivo
- **file** - FileField - Archivo PDF/Excel subido (upload_to='attendances/')
- **description** - TextField - OPCIONAL - Descripci√≥n adicional
- **reviewed** - BooleanField - DEFAULT: False - Si fue revisado
- **reviewed_by** (FK) - ForeignKey(User) - NULL PERMITIDO - Admin que revis√≥
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 10. **Incapacity** (attendance_incapacity)
**Descripci√≥n:** Incapacidades m√©dicas de monitores

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **user** (FK) - ForeignKey(User) - Monitor con incapacidad
- **start_date** - DateField - Fecha de inicio
- **end_date** - DateField - Fecha de fin
- **document** - FileField - Documento m√©dico (upload_to='incapacities/')
- **description** - TextField - OPCIONAL - Descripci√≥n/motivo
- **approved** - BooleanField - DEFAULT: False - Si est√° aprobada
- **approved_by** (FK) - ForeignKey(User) - NULL PERMITIDO - Admin que aprob√≥
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 11. **Course** (courses_course)
**Descripci√≥n:** Cursos programados en salas con monitores asignados

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **name** - CharField(200) - Nombre del curso
- **description** - TextField - OPCIONAL - Descripci√≥n del curso
- **room** (FK) - ForeignKey(Room) - Sala donde se imparte
- **schedule** (FK) - ForeignKey(Schedule) - Turno asociado del monitor
- **start_datetime** - DateTimeField - Inicio del curso
- **end_datetime** - DateTimeField - Fin del curso
- **status** - CharField(15) - Valores: 'scheduled', 'in_progress', 'completed', 'cancelled' - DEFAULT: 'scheduled'
- **created_by** (FK) - ForeignKey(User) - NULL PERMITIDO - Admin creador (role='admin')
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 12. **CourseHistory** (courses_coursehistory)
**Descripci√≥n:** Historial de cambios en cursos

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **course** (FK) - ForeignKey(Course) - Curso modificado
- **action** - CharField(10) - Valores: 'create', 'update', 'delete'
- **changes** - JSONField - Detalles de cambios realizados
- **changed_by** (FK) - ForeignKey(User) - NULL PERMITIDO - Usuario que modific√≥
- **timestamp** - DateTimeField - Auto add - Momento del cambio

---

### 13. **Notification** (notifications_notification)
**Descripci√≥n:** Notificaciones del sistema para usuarios

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **user** (FK) - ForeignKey(User) - Usuario destinatario
- **notification_type** - CharField(30) - Tipo de notificaci√≥n
  - Valores: 'room_entry', 'room_exit', 'incapacity', 'equipment_report', 'attendance', 'admin_verification', 'excessive_hours', 'schedule_non_compliance', 'conversation_message'
- **title** - CharField(200) - T√≠tulo de la notificaci√≥n
- **message** - TextField - Mensaje detallado
- **related_object_id** - IntegerField - NULL PERMITIDO - ID del objeto relacionado
- **read** - BooleanField - DEFAULT: False - Si fue le√≠da
- **read_timestamp** - DateTimeField - NULL PERMITIDO - Cu√°ndo se ley√≥
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 14. **Report** (reports_report)
**Descripci√≥n:** Reportes generados del sistema

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **title** - CharField(200) - T√≠tulo del reporte
- **report_type** - CharField(30) - Tipo de reporte
  - Valores: 'hours_summary', 'attendance', 'equipment_status', 'incapacity'
- **start_date** - DateField - Fecha inicial del per√≠odo
- **end_date** - DateField - Fecha final del per√≠odo
- **format** - CharField(10) - Valores: 'pdf', 'excel' - DEFAULT: 'pdf'
- **file** - FileField - NULL PERMITIDO - Archivo generado (upload_to='reports/')
- **created_by** (FK) - ForeignKey(User) - Usuario que gener√≥
- **user_filter** (FK) - ForeignKey(User) - NULL PERMITIDO - Filtro por usuario espec√≠fico
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update

---

### 15. **ExportJob** (export_exportjob)
**Descripci√≥n:** Trabajos de exportaci√≥n de datos

#### Atributos:
- **id** (PK) - AutoField - Clave primaria
- **title** - CharField(200) - T√≠tulo de la exportaci√≥n
- **export_type** - CharField(30) - Tipo de exportaci√≥n
  - Valores: 'monitors_data', 'attendance_data', 'schedule_data', 'room_entries_data'
- **format** - CharField(10) - Valores: 'pdf', 'excel'
- **status** - CharField(15) - Valores: 'pending', 'processing', 'completed', 'failed' - DEFAULT: 'pending'
- **start_date** - DateField - NULL PERMITIDO - Filtro fecha inicial
- **end_date** - DateField - NULL PERMITIDO - Filtro fecha final
- **monitor_ids** - JSONField - NULL PERMITIDO - Lista de IDs espec√≠ficos
- **file** - FileField - NULL PERMITIDO - Archivo generado (upload_to='exports/')
- **requested_by** (FK) - ForeignKey(User) - Usuario que solicita
- **created_at** - DateTimeField - Auto add
- **updated_at** - DateTimeField - Auto update
- **completed_at** - DateTimeField - NULL PERMITIDO - Cu√°ndo complet√≥
- **error_message** - TextField - OPCIONAL - Mensaje si fall√≥
- **file_size** - BigIntegerField - NULL PERMITIDO - Tama√±o en bytes

---

## üîó RELACIONES Y CARDINALIDADES

### **RELACIONES 1:N (Uno a Muchos)**

1. **User ‚Üí ApprovalLink**
   - Un usuario puede tener m√∫ltiples enlaces de aprobaci√≥n
   - `User.approval_links` ‚Üê `ApprovalLink.user`

2. **User ‚Üí PasswordReset**
   - Un usuario puede tener m√∫ltiples tokens de reset
   - `User.password_resets` ‚Üê `PasswordReset.user`

3. **User ‚Üí User** (Auto-referencia)
   - Un admin puede verificar m√∫ltiples usuarios
   - `User.verified_users` ‚Üê `User.verified_by`

4. **Room ‚Üí RoomEntry**
   - Una sala puede tener m√∫ltiples entradas
   - `Room.entries` ‚Üê `RoomEntry.room`

5. **User ‚Üí RoomEntry**
   - Un monitor puede tener m√∫ltiples entradas
   - `User.room_entries` ‚Üê `RoomEntry.user`

6. **Room ‚Üí Schedule**
   - Una sala puede tener m√∫ltiples turnos
   - `Room.schedules` ‚Üê `Schedule.room`

7. **User ‚Üí Schedule**
   - Un monitor puede tener m√∫ltiples turnos
   - `User.schedules` ‚Üê `Schedule.user`

8. **User ‚Üí Schedule** (created_by)
   - Un admin puede crear m√∫ltiples turnos
   - `User.created_schedules` ‚Üê `Schedule.created_by`

9. **Room ‚Üí Equipment**
   - Una sala puede tener m√∫ltiples equipos
   - `Room.equipment` ‚Üê `Equipment.room`

10. **Equipment ‚Üí EquipmentReport**
    - Un equipo puede tener m√∫ltiples reportes
    - `Equipment.reports` ‚Üê `EquipmentReport.equipment`

11. **User ‚Üí EquipmentReport**
    - Un usuario puede reportar m√∫ltiples equipos
    - `User.equipment_reports` ‚Üê `EquipmentReport.reported_by`

12. **User ‚Üí Attendance**
    - Un monitor puede subir m√∫ltiples listados
    - `User.uploaded_attendances` ‚Üê `Attendance.uploaded_by`

13. **User ‚Üí Attendance** (reviewed_by)
    - Un admin puede revisar m√∫ltiples listados
    - `User.reviewed_attendances` ‚Üê `Attendance.reviewed_by`

14. **User ‚Üí Incapacity**
    - Un monitor puede tener m√∫ltiples incapacidades
    - `User.incapacities` ‚Üê `Incapacity.user`

15. **User ‚Üí Incapacity** (approved_by)
    - Un admin puede aprobar m√∫ltiples incapacidades
    - `User.approved_incapacities` ‚Üê `Incapacity.approved_by`

16. **Room ‚Üí Course**
    - Una sala puede tener m√∫ltiples cursos
    - `Room.courses` ‚Üê `Course.room`

17. **Schedule ‚Üí Course**
    - Un turno puede tener m√∫ltiples cursos asignados
    - `Schedule.course_assignments` ‚Üê `Course.schedule`

18. **User ‚Üí Course** (created_by)
    - Un admin puede crear m√∫ltiples cursos
    - `User.created_courses` ‚Üê `Course.created_by`

19. **Course ‚Üí CourseHistory**
    - Un curso puede tener m√∫ltiples entradas de historial
    - `Course.history` ‚Üê `CourseHistory.course`

20. **User ‚Üí CourseHistory**
    - Un usuario puede modificar m√∫ltiples cursos
    - `User.course_histories` ‚Üê `CourseHistory.changed_by`

21. **User ‚Üí Notification**
    - Un usuario puede recibir m√∫ltiples notificaciones
    - `User.notifications_received` ‚Üê `Notification.user`

22. **User ‚Üí Report**
    - Un usuario puede generar m√∫ltiples reportes
    - `User.reports` ‚Üê `Report.created_by`

23. **User ‚Üí Report** (user_filter)
    - Un usuario puede ser filtro de m√∫ltiples reportes
    - `User.filtered_reports` ‚Üê `Report.user_filter`

24. **User ‚Üí ExportJob**
    - Un usuario puede solicitar m√∫ltiples exportaciones
    - `User.export_jobs` ‚Üê `ExportJob.requested_by`

---

## üîë CLAVES E √çNDICES

### **CLAVES PRIMARIAS (PK)**
Todas las entidades tienen **id (AutoField)** como clave primaria.

### **CLAVES FOR√ÅNEAS (FK)**
- **ApprovalLink.user** ‚Üí User.id
- **PasswordReset.user** ‚Üí User.id  
- **User.verified_by** ‚Üí User.id (auto-referencia)
- **RoomEntry.user** ‚Üí User.id
- **RoomEntry.room** ‚Üí Room.id
- **Schedule.user** ‚Üí User.id
- **Schedule.room** ‚Üí Room.id
- **Schedule.created_by** ‚Üí User.id
- **Equipment.room** ‚Üí Room.id
- **EquipmentReport.equipment** ‚Üí Equipment.id
- **EquipmentReport.reported_by** ‚Üí User.id
- **Attendance.uploaded_by** ‚Üí User.id
- **Attendance.reviewed_by** ‚Üí User.id
- **Incapacity.user** ‚Üí User.id
- **Incapacity.approved_by** ‚Üí User.id
- **Course.room** ‚Üí Room.id
- **Course.schedule** ‚Üí Schedule.id
- **Course.created_by** ‚Üí User.id
- **CourseHistory.course** ‚Üí Course.id
- **CourseHistory.changed_by** ‚Üí User.id
- **Notification.user** ‚Üí User.id
- **Report.created_by** ‚Üí User.id
- **Report.user_filter** ‚Üí User.id
- **ExportJob.requested_by** ‚Üí User.id

### **RESTRICCIONES √öNICAS**
- **User**: username, email, identification
- **ApprovalLink**: token_hash
- **PasswordReset**: token_hash
- **Room**: code
- **Equipment**: serial_number

### **√çNDICES COMPUESTOS**
- **ApprovalLink**: [token_hash], [user, action], [expires_at]
- **PasswordReset**: [token_hash], [user], [expires_at]
- **Course**: [start_datetime, end_datetime], [room, start_datetime], [schedule, start_datetime]

---

## üìã RESTRICCIONES DE INTEGRIDAD

### **CHECK CONSTRAINTS**
1. **Schedule**: `end_datetime > start_datetime`
2. **User.role**: Valores permitidos: 'admin', 'monitor'
3. **Schedule.status**: Valores permitidos: 'active', 'completed', 'cancelled'
4. **Equipment.status**: Valores permitidos: 'operational', 'maintenance', 'out_of_service'
5. **Course.status**: Valores permitidos: 'scheduled', 'in_progress', 'completed', 'cancelled'

### **VALIDACIONES DE NEGOCIO**
1. **Schedule.user** debe tener role='monitor' y is_verified=True
2. **Schedule.created_by** debe tener role='admin'
3. **Course.created_by** debe tener role='admin'
4. Duraci√≥n de Schedule no puede exceder 12 horas
5. Duraci√≥n de Course no puede exceder 8 horas

---

## üéØ PATRONES DE ACCESO PRINCIPALES

### **Por Usuario**
- Obtener turnos de un monitor: `Schedule.objects.filter(user=monitor)`
- Obtener entradas de sala: `RoomEntry.objects.filter(user=monitor)`
- Obtener notificaciones: `Notification.objects.filter(user=user)`

### **Por Sala**
- Obtener ocupantes actuales: `RoomEntry.objects.filter(room=sala, exit_time__isnull=True)`
- Obtener equipos: `Equipment.objects.filter(room=sala)`
- Obtener turnos: `Schedule.objects.filter(room=sala)`

### **Por Fecha**
- Turnos del d√≠a: `Schedule.objects.filter(start_datetime__date=fecha)`
- Cursos del per√≠odo: `Course.objects.filter(start_datetime__range=[inicio, fin])`
- Reportes de per√≠odo: `Report.objects.filter(start_date__lte=fecha, end_date__gte=fecha)`

---

## üìä RESUMEN DE CARDINALIDADES

```
User (1) ‚Üê‚Üí (N) ApprovalLink
User (1) ‚Üê‚Üí (N) PasswordReset  
User (1) ‚Üê‚Üí (N) User (auto-referencia)
Room (1) ‚Üê‚Üí (N) RoomEntry
User (1) ‚Üê‚Üí (N) RoomEntry
Room (1) ‚Üê‚Üí (N) Schedule
User (1) ‚Üê‚Üí (N) Schedule
Room (1) ‚Üê‚Üí (N) Equipment
Equipment (1) ‚Üê‚Üí (N) EquipmentReport
User (1) ‚Üê‚Üí (N) EquipmentReport
User (1) ‚Üê‚Üí (N) Attendance
User (1) ‚Üê‚Üí (N) Incapacity
Room (1) ‚Üê‚Üí (N) Course
Schedule (1) ‚Üê‚Üí (N) Course
Course (1) ‚Üê‚Üí (N) CourseHistory
User (1) ‚Üê‚Üí (N) Notification
User (1) ‚Üê‚Üí (N) Report
User (1) ‚Üê‚Üí (N) ExportJob
```

**Total de Entidades:** 15
**Total de Relaciones:** 24
**Relaciones 1:N:** 24
**Relaciones N:N:** 0 (se usan tablas intermedias si es necesario)

---

*Este documento debe ser usado como referencia exacta para crear el diagrama entidad-relaci√≥n del Sistema DS2.*